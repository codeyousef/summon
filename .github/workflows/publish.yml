name: Publish Summon

on:
  workflow_dispatch:
  push:
    branches:
      - main
    tags:
      - 'v*'
      - '*.*.*.*'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: 'gradle'

      - name: Build and test
        run: |
          ./gradlew build --stacktrace --no-daemon

      - name: Prepare local.properties for Central (tags only)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cat > local.properties <<'EOF'
          mavenCentralUsername=${{ secrets.MAVEN_CENTRAL_USERNAME }}
          mavenCentralPassword=${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          signingPassword=${{ secrets.SIGNING_PASSWORD }}
          EOF

      - name: Write GPG private key file (tags only)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY_ASC }}" > private-key-ascii.asc
          chmod 600 private-key-ascii.asc

      - name: Publish to codes.yousef via Central Portal API (tags only)
        if: startsWith(github.ref, 'refs/tags/')
        env:
          MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        run: |
          ./gradlew :summon-core:publishToCentralPortalManually --stacktrace --no-daemon

      - name: Publish legacy bundle to io.github.codeyousef (until 0.5.0.0) (tags only)
        if: startsWith(github.ref, 'refs/tags/') && (startsWith(github.ref_name, 'v0.4.') || startsWith(github.ref_name, '0.4.') || github.ref_name == 'v0.5.0.0' || github.ref_name == '0.5.0.0')
        env:
          MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        run: |
          ./gradlew :summon-core:publishToLegacyGroupId --stacktrace --no-daemon
