name: Publish Summon

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx2g -Dorg.gradle.vfs.watch=false"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Grant execute permissions
        run: |
          chmod +x gradlew
          if [ -f sign-artifact.sh ]; then
            chmod +x sign-artifact.sh
          fi

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: 'gradle'

      - name: Extract version from version.properties
        id: version
        shell: bash
        run: |
          VERSION=$(grep "^VERSION=" version.properties | cut -d'=' -f2)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            TAG="${GITHUB_REF_NAME}"
            if [[ "$TAG" != "v$VERSION" ]]; then
              echo "::error::Tag $TAG does not match version v$VERSION from version.properties"
              exit 1
            fi
          fi

      - name: Build and test
        run: ./gradlew --no-daemon --max-workers=4 --console=plain build --stacktrace

      - name: Ensure tag does not already exist
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if git ls-remote --tags origin "refs/tags/v${VERSION}" | grep -q .; then
            echo "::error::Tag v${VERSION} already exists. Bump version.properties before releasing."
            exit 1
          fi

      - name: Setup publishing secrets (fallback to legacy names)
        id: setup-secrets
        shell: bash
        run: |
          USER="${{ secrets.MAVEN_CENTRAL_USERNAME != '' && secrets.MAVEN_CENTRAL_USERNAME || secrets.CENTRAL_USERNAME }}"
          PASS="${{ secrets.MAVEN_CENTRAL_PASSWORD != '' && secrets.MAVEN_CENTRAL_PASSWORD || secrets.CENTRAL_PASSWORD }}"
          SIGN_PW="${{ secrets.SIGNING_PASSWORD != '' && secrets.SIGNING_PASSWORD || secrets.CENTRAL_SIGNING_PASSWORD }}"
          SIGN_KEY="${{ secrets.GPG_PRIVATE_KEY_ASC != '' && secrets.GPG_PRIVATE_KEY_ASC || secrets.CENTRAL_SIGNING_KEY_ASC }}"

          if [[ -z "$USER" || -z "$PASS" || -z "$SIGN_PW" || -z "$SIGN_KEY" ]]; then
            echo "::error::One or more required publishing secrets are missing (username/password/signing password/key)."; exit 1;
          fi

          cat <<EOF > local.properties
          mavenCentralUsername=${USER}
          mavenCentralPassword=${PASS}
          signingPassword=${SIGN_PW}
          signingKey=provided-via-secret
          EOF

          # Try base64 decode first; fallback to raw armored key
          if echo "$SIGN_KEY" | base64 -d > private-key.asc 2>/tmp/base64-decode.log; then
            echo "Imported signing key from base64-encoded secret"
          else
            echo "$SIGN_KEY" > private-key.asc
            echo "Stored signing key as literal ASCII-armored block"
          fi
          chmod 600 private-key.asc

          TMP_GNUPGHOME=$(mktemp -d)
          export GNUPGHOME="$TMP_GNUPGHOME"
          if ! gpg --batch --yes --import private-key.asc >/tmp/gpg-import.log 2>&1; then
            echo "::error::Signing key could not be imported"; cat /tmp/gpg-import.log || true; rm -rf "$TMP_GNUPGHOME"; exit 1
          fi
          rm -rf "$TMP_GNUPGHOME"

      - name: Publish (auto-select dual or single)
        shell: bash
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ "$VERSION" =~ ^0\.4\. || "$VERSION" == "0.5.0.0" ]]; then
            echo "üîÑ Dual publishing (new + legacy) for version $VERSION"
            ./gradlew :summon-core:publishToBothGroupIds --stacktrace --no-daemon
          else
            echo "‚û°Ô∏è Publishing only to new group (codes.yousef) for version $VERSION"
            ./gradlew :summon-core:publishToCentralPortalManually --stacktrace --no-daemon
          fi

      - name: Extract latest changelog entry
        id: changelog
        shell: bash
        run: |
          python <<'PY'
          import itertools

          with open("CHANGELOG.md", encoding="utf-8") as fh:
              lines = fh.readlines()

          section = []
          capture = False
          for line in lines:
              if line.startswith("## ["):
                  if capture:
                      break
                  capture = True
                  continue
              if capture:
                  section.append(line.rstrip("\n"))

          notes = "\n".join(section).strip()
          print(notes)
          with open("release-notes.md", "w", encoding="utf-8") as out:
              out.write(notes + "\n")
          PY
          NOTES=$(cat release-notes.md)
          echo "notes<<EOF" >> "$GITHUB_OUTPUT"
          echo "$NOTES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create and push release tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${VERSION}" -m "Summon ${VERSION}"
          git push origin "v${VERSION}"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Summon ${{ steps.version.outputs.version }}
          body_path: release-notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build CLI
        run: ./gradlew summon-cli:build -PskipWrapperTests=true

      - name: Publish CLI to GitHub Packages
        run: ./gradlew summon-cli:publishCliPublicationToGitHubPackagesRepository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
