<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Summon Button Hydration</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-button { 
            padding: 12px 24px; 
            background-color: #0d6efd; 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 10px;
        }
        .log { 
            margin-top: 20px; 
            padding: 10px; 
            background: #f5f5f5; 
            border-radius: 4px; 
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Test Summon Button Hydration</h1>
    <p>Testing if buttons work after the hydration fix...</p>
    
    <button class="test-button" data-onclick-id="test-button-123" data-onclick-action="true">
        Click Me - Test Button
    </button>
    
    <div class="log">
        <h3>Hydration Log:</h3>
        <div id="log-entries"></div>
    </div>
    
    <!-- Hydration data with same format as Spring Boot -->
    <script type="application/json" id="summon-hydration-data">
        {"version":1,"callbacks":{"test-button-123":{"type":"test","message":"Button clicked successfully!"}},"timestamp":1756137700000}
    </script>
    
    <script>
        function log(message) {
            const entries = document.getElementById('log-entries');
            const time = new Date().toLocaleTimeString();
            entries.innerHTML += '<div>' + time + ': ' + message + '</div>';
            entries.scrollTop = entries.scrollHeight;
        }
        
        // Test the hydration without loading external script first
        log('üîÑ Starting hydration test...');
        
        // Check if hydration data exists
        const dataElement = document.getElementById('summon-hydration-data');
        if (dataElement) {
            log('‚úÖ Found hydration data script');
            const jsonData = JSON.parse(dataElement.textContent);
            log('üìä Parsed hydration data: ' + JSON.stringify(jsonData));
            
            // Test the parsing logic manually
            const callbacks = jsonData.callbacks;
            if (Array.isArray(callbacks)) {
                log('üìã Callbacks is array: ' + callbacks.join(', '));
            } else {
                log('üìã Callbacks is object with keys: ' + Object.keys(callbacks).join(', '));
            }
        } else {
            log('‚ùå No hydration data found');
        }
        
        // Check button attributes
        const button = document.querySelector('[data-onclick-action="true"]');
        if (button) {
            const callbackId = button.getAttribute('data-onclick-id');
            log('üîò Found button with callback ID: ' + callbackId);
        } else {
            log('‚ùå No buttons with data-onclick-action found');
        }
    </script>
    
    <!-- Load the actual hydration script -->
    <script>
        log('üì• Loading hydration script from Spring Boot app...');
    </script>
    <script src="http://localhost:8080/summon-hydration.js" 
            onload="log('‚úÖ Hydration script loaded successfully')"
            onerror="log('‚ùå Failed to load hydration script')"></script>
    
    <script>
        // Test after a delay to ensure hydration completed
        setTimeout(() => {
            const button = document.querySelector('[data-onclick-id="test-button-123"]');
            if (button) {
                log('üîç Checking button event listeners...');
                
                // Check if the hydration client added event listeners
                const hasListeners = button.onclick || button.addEventListener.toString().includes('native');
                log('üéß Button has event listeners: ' + hasListeners);
                
                // Try to trigger the button manually
                log('‚ö° Simulating button click...');
                button.click();
            }
        }, 2000);
        
        // Override fetch to intercept callback requests
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            log('üåê Intercepted fetch request to: ' + url);
            if (options && options.body) {
                log('üì§ Request body: ' + options.body);
            }
            return originalFetch.apply(this, arguments)
                .then(response => {
                    log('‚úÖ Fetch response: ' + response.status);
                    return response;
                })
                .catch(error => {
                    log('‚ùå Fetch error: ' + error.message);
                    throw error;
                });
        };
    </script>
</body>
</html>